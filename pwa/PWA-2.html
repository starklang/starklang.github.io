<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>PWA Block Game</title>
<style type="text/css">
* {
  margin: 0;
  padding: 0;
  border: 0;
}

body {
  background: #000;
  font: 30px sans-serif;
}
</style>
</head>
<body>
<!-- generated by: jsdo.it - http://jsdo.it/naoyashiga/jR2i -->
<!-- Copyright naoyashiga - http://jsdo.it/naoyashiga -->
<!-- Licensed under MIT License - http://www.opensource.org/licenses/mit-license.php -->
<script type="text/javascript" src="paper.js"></script>
<script type="text/paperscript" canvas="myCanvas">
var brickWidth = view.size.width / 12,//レンガの横幅
    brickHeight = view.size.height / 48,//レンガの縦幅
    rows = 10,//レンガを並べる行数
    cols = 10,//レンガを並べる列数
    xMargin = 3,//レンガ同士のX方向の間隔
    yMargin = 3,//レンガ同士のY方向の間隔
    bulletRadius = 10,//弾丸の半径
    vMin = 3,
    vMax = 6,
    bullets = [];

var hitOptions = {
    segments: true,
    stroke: true,
    fill: true,
    tolerance: 2,
    bounds:true
};
/*-----------------------------------
    レンガ
-----------------------------------*/
//レンガを作成
var brick = new Rectangle();
brick.size = new Size(brickWidth, brickHeight);

//レンガのパス
var path = new Path.Rectangle(brick);
path.fillColor = '#444';

//レンガをシンボル化
var symbol = new Symbol(path);

//レンガを並べる
for(var y = 0;y < rows;y++){
    for(var x = 0;x < cols;x++){
        var center = new Point(x, y) * [brick.size.width + xMargin,brick.size.height + yMargin];
        symbol.place(center);
    }
}
//レンガのレイヤーを中央に移動
project.activeLayer.position = [view.size.width / 2,view.size.height / 4];

/*-----------------------------------
    レイヤー構成
    -レイヤー0
    --レンガ
    -レイヤー1
    --弾丸
    --プレイヤー
-----------------------------------*/
//レイヤー1を新規作成
var secondLayer = new Layer();
//レイヤー0のレンガを取得
var brickChildren = project.layers[0].children;

/*-----------------------------------
    弾丸
-----------------------------------*/
//弾丸を生成
for(var i = 0;i < 7;i++){
    bullets.push(new Bullet(i));
}

function Bullet(i){
    this.vx = getRandomNum(vMin,vMax);
    this.vy = getRandomNum(vMin,vMax);
    this.path = new Path.Circle({
        center:[50 + i * bulletRadius * 3,view.size.height - 50],
        radius:bulletRadius,
        fillColor:"#f39c12"
    });
}
/*-----------------------------------
    プレイヤー(バー)
-----------------------------------*/
var playerRect = new Rectangle();
playerRect.size = new Size(100, 10);
playerRect.center = new Point(view.size.width / 2,view.size.height - 50);

var player = new Path.Rectangle(playerRect);
player.fillColor = '#444';

/*-----------------------------------
    範囲を決めて乱数生成
-----------------------------------*/
function getRandomNum( min, max ) {
    return ( Math.random() * ( max - min ) + min ) | 0;
}

/*-----------------------------------
    マウスの動きに合わせてプレイヤーが移動
-----------------------------------*/
function onMouseMove(event){
    player.position.x = event.point.x;
    //垂直方向の壁
    if(player.bounds.left < 0){//左の壁
        player.position.x = player.bounds.width / 2;
    }else if(player.bounds.right > view.size.width){//右の壁
        player.position.x = view.size.width - player.bounds.width / 2;
    }
}

function onFrame(event){
    for(var j = 0;j < bullets.length;j++){
        //弾丸の移動
        bullets[j].path.position.x += bullets[j].vx;
        bullets[j].path.position.y -= bullets[j].vy;

        //垂直方向の壁に対する弾丸の跳ね返り
        if(bullets[j].path.bounds.left < 0 || bullets[j].path.bounds.right > view.size.width){
                bullets[j].vx *= -1;
        }

        //水平方向の壁に対する弾丸の跳ね返り
        if(bullets[j].path.bounds.top < 0 || bullets[j].path.bounds.bottom > view.size.height){
                bullets[j].vy *= -1;
        }

        //プレイヤーに対する弾丸の当たり判定
        var hitResult = player.hitTest(bullets[j].path.bounds.bottomLeft,hitOptions) ||
        player.hitTest(bullets[j].path.bounds.bottomCenter,hitOptions) ||
        player.hitTest(bullets[j].path.bounds.bottomRight,hitOptions) ||
        player.hitTest(bullets[j].path.bounds.topLeft,hitOptions) ||
        player.hitTest(bullets[j].path.bounds.topCenter,hitOptions) ||
        player.hitTest(bullets[j].path.bounds.topRight,hitOptions);
        //var hitResult = player.hitTest(bullets[j].path.position,hitOptions);

        if(hitResult){
            if(hitResult.type == "fill"){
                //跳ね返る
                bullets[j].vy *= -1;
            }
        }

        //レンガに対する弾丸の当たり判定
        for(var i = 0;i < brickChildren.length;i++){
            var hitResult2 = brickChildren[i].hitTest(bullets[j].path.position,hitOptions);

            if(hitResult2){
                //跳ね返る
                bullets[j].vy *= -1;
                //レンガ消滅
                brickChildren[i].remove();
            }
        }

        //弾丸同士当たり判定
        for(var k = 0;k < bullets.length;k++){
            //var hitResult3 = bullets[j].path.hitTest(bullets[k].path.position,hitOptions);
            var hitResult3 = bullets[j].path.hitTest(bullets[k].path.bounds.bottomLeft,hitOptions) ||
                bullets[j].path.hitTest(bullets[k].path.bounds.bottomCenter,hitOptions) ||
                bullets[j].path.hitTest(bullets[k].path.bounds.bottomRight,hitOptions) ||
                bullets[j].path.hitTest(bullets[k].path.bounds.topLeft,hitOptions) ||
                bullets[j].path.hitTest(bullets[k].path.bounds.topCenter,hitOptions) ||
                bullets[j].path.hitTest(bullets[k].path.bounds.topRight,hitOptions);
            if(hitResult3){
                //質量が同じ物体同士の完全弾性衝突
                //速度が入れ替わる
                var tmp = bullets[j].vx;
                bullets[j].vx = bullets[k].vx;
                bullets[k].vx = tmp;

                tmp = bullets[j].vy;
                bullets[j].vy = bullets[k].vy;
                bullets[k].vy = tmp;
            }
        }
    }
}
</script>
<canvas id="myCanvas" resize></canvas>
</body>
</html>